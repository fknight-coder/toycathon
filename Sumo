#include <Wire.h>
#include <VL53L0X.h>

VL53L0X sensor;

// ---- Motor Pins ----
#define AIN1 4
#define AIN2 3
#define BIN1 6
#define BIN2 7
#define STBY 5
#define PWMA 9
#define PWMB 10

// ---- Edge Sensors ----
#define LEFT_EDGE 2
#define RIGHT_EDGE 8

// ---- Settings ----
#define ATTACK_DISTANCE 300
#define SEARCH_SPEED 140
#define ATTACK_SPEED 255
#define ESCAPE_SPEED 180

void setup() {
  Serial.begin(115200);
  Wire.begin();

  pinMode(AIN1, OUTPUT);
  pinMode(AIN2, OUTPUT);
  pinMode(BIN1, OUTPUT);
  pinMode(BIN2, OUTPUT);
  pinMode(PWMA, OUTPUT);
  pinMode(PWMB, OUTPUT);
  pinMode(STBY, OUTPUT);

  pinMode(LEFT_EDGE, INPUT);
  pinMode(RIGHT_EDGE, INPUT);

  digitalWrite(STBY, HIGH);

  sensor.setTimeout(200);
  if (!sensor.init()) {
    while (1);
  }

  sensor.setMeasurementTimingBudget(20000);
  sensor.startContinuous();
}

void loop() {

  // ----- EDGE PROTECTION (HIGHEST PRIORITY) -----
  if (digitalRead(LEFT_EDGE) == HIGH) {
    escapeRight();
    return;
  }

  if (digitalRead(RIGHT_EDGE) == HIGH) {
    escapeLeft();
    return;
  }

  // ----- ENEMY DETECTION -----
  uint16_t distance = sensor.readRangeContinuousMillimeters();
  if (sensor.timeoutOccurred()) return;

  if (distance < ATTACK_DISTANCE && distance > 50) {
    attack();
  } else {
    search();
  }
}

// -------- MOVEMENTS --------

void attack() {
  moveForward(ATTACK_SPEED);
}

void search() {
  rotateRight(SEARCH_SPEED);
}

void escapeLeft() {
  moveBackward(ESCAPE_SPEED);
  delay(250);
  rotateLeft(ESCAPE_SPEED);
  delay(300);
}

void escapeRight() {
  moveBackward(ESCAPE_SPEED);
  delay(250);
  rotateRight(ESCAPE_SPEED);
  delay(300);
}

void moveForward(int speedVal) {
  digitalWrite(AIN1, HIGH);
  digitalWrite(AIN2, LOW);
  analogWrite(PWMA, speedVal);

  digitalWrite(BIN1, HIGH);
  digitalWrite(BIN2, LOW);
  analogWrite(PWMB, speedVal);
}

void moveBackward(int speedVal) {
  digitalWrite(AIN1, LOW);
  digitalWrite(AIN2, HIGH);
  analogWrite(PWMA, speedVal);

  digitalWrite(BIN1, LOW);
  digitalWrite(BIN2, HIGH);
  analogWrite(PWMB, speedVal);
}

void rotateRight(int speedVal) {
  digitalWrite(AIN1, HIGH);
  digitalWrite(AIN2, LOW);
  analogWrite(PWMA, speedVal);

  digitalWrite(BIN1, LOW);
  digitalWrite(BIN2, HIGH);
  analogWrite(PWMB, speedVal);
}

void rotateLeft(int speedVal) {
  digitalWrite(AIN1, LOW);
  digitalWrite(AIN2, HIGH);
  analogWrite(PWMA, speedVal);

  digitalWrite(BIN1, HIGH);
  digitalWrite(BIN2, LOW);
  analogWrite(PWMB, speedVal);
}

